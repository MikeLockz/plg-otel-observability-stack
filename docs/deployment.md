# Deploying the Observability Stack with a Self-Hosted GitHub Runner

This guide details how to automate the deployment of the observability stack to a dedicated LXC container using a self-hosted GitHub Actions runner.

## 1. Preparing the LXC Container as a GitHub Runner

The first step is to configure an LXC container to act as a self-hosted runner for your GitHub repository.

### Prerequisites

*   An LXC container with a static IP address.
*   Docker and Docker Compose installed in the container.
*   Sudo privileges for the user who will run the GitHub runner.

### Installation and Configuration Steps

1.  **Create a dedicated user (optional but recommended)**:
    It's a good practice to run the GitHub runner under a dedicated user account.
    ```sh
    sudo adduser github-runner
    sudo usermod -aG sudo github-runner
    sudo usermod -aG docker github-runner
    su - github-runner
    ```

2.  **Navigate to your GitHub repository's runner settings**:
    Go to `Settings` > `Actions` > `Runners` and click on `New self-hosted runner`.

3.  **Download and Configure the Runner**:
    Follow the instructions provided on the GitHub page. They will look similar to this:

    ```sh
    # Create a folder
    mkdir actions-runner && cd actions-runner

    # Download the latest runner package
    curl -o actions-runner-linux-x64-2.311.0.tar.gz -L https://github.com/actions/runner/releases/download/v2.311.0/actions-runner-linux-x64-2.311.0.tar.gz

    # Extract the installer
    tar xzf ./actions-runner-linux-x64-2.311.0.tar.gz

    # Create the runner and configure it
    ./config.sh --url https://github.com/MikeLockz/plg-otel-observability-stack --token YOUR_TOKEN
    ```
    *   **--url**: The URL to your repository.
    *   **--token**: A temporary token generated by GitHub for registration.

4.  **Install and Start the Runner as a Service**:
    To ensure the runner starts automatically on boot, install it as a systemd service.

    ```sh
    sudo ./svc.sh install
    sudo ./svc.sh start
    ```

5.  **Verify the Runner**:
    Check the status of the runner service:
    ```sh
    sudo ./svc.sh status
    ```
    You should also see the runner with a green "Idle" status in your GitHub repository's runner settings.

## 2. Configuring GitHub Repository Settings

No special repository secrets are needed for this basic deployment. The runner will have access to the repository code by default. Ensure that your repository's Actions settings (`Settings` > `Actions` > `General`) are configured to allow local and third-party actions, as needed.

## 3. GitHub Actions Workflow for Deployment

Create a workflow file in your repository at `.github/workflows/deploy.yml`. This workflow will trigger on a push to the `main` branch, check out the code, and deploy the stack using Docker Compose.

### Create the Workflow File

1.  Create the directory and file:
    ```sh
    mkdir -p .github/workflows
    touch .github/workflows/deploy.yml
    ```

2.  Add the following content to `deploy.yml`:

    ```yaml
    name: Deploy Observability Stack

    on:
      push:
        branches:
          - main

    jobs:
      deploy:
        name: Deploy to LXC
        runs-on: self-hosted
        steps:
          - name: Checkout Repository
            uses: actions/checkout@v4

          - name: Deploy Docker Compose Stack
            run: |
              echo "Starting deployment..."
              docker-compose up -d --build
              echo "Deployment complete."

          - name: Prune Old Docker Images
            if: always()
            run: |
              echo "Cleaning up old Docker images..."
              docker image prune -f
    ```

### Workflow Explanation

*   **`name`**: The name of the workflow.
*   **`on`**: This workflow triggers on any `push` to the `main` branch.
*   **`jobs`**: Defines the work to be done.
    *   **`deploy`**: The name of the job.
    *   **`runs-on: self-hosted`**: This is the crucial part. It tells GitHub to execute this job on a runner that is self-hosted, which will be the LXC container you configured.
    *   **`steps`**:
        *   **`Checkout Repository`**: This uses the standard `actions/checkout` action to pull your repository's code into the runner's workspace.
        *   **`Deploy Docker Compose Stack`**: This step runs `docker-compose up -d --build`. The `--build` flag ensures that any changes to your configuration files are reflected in the running containers.
        *   **`Prune Old Docker Images`**: This optional but recommended step cleans up old, unused Docker images to save disk space. It runs `if: always()` to ensure cleanup happens even if the deployment step fails.

With this setup, every time you push a change to the `main` branch, the GitHub runner in your LXC will automatically update and redeploy the observability stack.
